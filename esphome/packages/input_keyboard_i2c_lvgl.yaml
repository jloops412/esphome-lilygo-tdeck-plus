interval:
  - interval: 35ms
    then:
      - lambda: |-
          // ALT on this keyboard path is observed as ESC-prefix behavior.
          if (id(kb_alt_pending)) {
            uint32_t now = esphome::millis();
            if ((now - id(kb_alt_pending_ms)) > 700) {
              id(kb_alt_pending) = false;
            }
          }

          uint8_t key = 0;
          auto err = id(bus_a).read(0x55, &key, 1);
          if (err != esphome::i2c::ERROR_OK || key == 0x00) {
            return;
          }

          if (id(wake_on_keyboard)) {
            id(last_activity_ms) = esphome::millis();
            if (id(screensaver_active)) {
              id(wake_display).execute();
            }
          }

          if (key == 0x1B) {
            id(kb_alt_pending) = true;
            id(kb_alt_pending_ms) = esphome::millis();
            return;
          }

          bool alt_combo = false;
          if (id(kb_alt_pending)) {
            id(kb_alt_pending) = false;
            alt_combo = true;
          }

          id(kb_last_alt) = alt_combo;
          id(kb_last_raw) = key;
          id(kb_last_code).publish_state(key);

          if (alt_combo && key >= 32 && key <= 126) {
            char up = static_cast<char>(key);
            if (up >= 'a' && up <= 'z') up = (char)(up - 32);
            char buf[8];
            snprintf(buf, sizeof(buf), "ALT+%c", up);
            id(kb_last_text).publish_state(buf);
            id(kb_last_text_buf) = std::string(buf);
            return;
          }

          if (key == 0x0D) {
            id(kb_last_text).publish_state("ENTER");
            id(kb_last_text_buf) = "ENTER";
          } else if (key == 0x08) {
            id(kb_last_text).publish_state("BACKSPACE");
            id(kb_last_text_buf) = "BKSP";
          } else if (key == 0x09) {
            id(kb_last_text).publish_state("TAB");
            id(kb_last_text_buf) = "TAB";
          } else if (key == 0x20) {
            id(kb_last_text).publish_state("SPACE");
            id(kb_last_text_buf) = "SPACE";
          } else if (key >= 32 && key <= 126) {
            char s[2];
            s[0] = static_cast<char>(key);
            s[1] = '\0';
            id(kb_last_text).publish_state(s);
            id(kb_last_text_buf) = std::string(s);
          } else {
            char buf[8];
            snprintf(buf, sizeof(buf), "0x%02X", key);
            id(kb_last_text).publish_state(buf);
            id(kb_last_text_buf) = std::string(buf);
          }

      - if:
          condition:
            lambda: "return id(kb_last_raw) != 0;"
          then:
            # All command shortcuts require ALT + key.
            - if:
                condition:
                  lambda: "return id(kb_last_alt) && (id(kb_last_raw) == 'h' || id(kb_last_raw) == 'H');"
                then:
                  - lvgl.page.show: home_page
            - if:
                condition:
                  lambda: "return id(kb_last_alt) && (id(kb_last_raw) == 'l' || id(kb_last_raw) == 'L');"
                then:
                  - lvgl.page.show: lights_page
            - if:
                condition:
                  lambda: "return id(kb_last_alt) && (id(kb_last_raw) == 'a' || id(kb_last_raw) == 'A');"
                then:
                  - script.execute: open_light_colors
            - if:
                condition:
                  lambda: "return id(kb_last_alt) && (id(kb_last_raw) == 'w' || id(kb_last_raw) == 'W');"
                then:
                  - lvgl.page.show: weather_page
            - if:
                condition:
                  lambda: "return id(kb_last_alt) && (id(kb_last_raw) == 'c' || id(kb_last_raw) == 'C');"
                then:
                  - lvgl.page.show: climate_page
            - if:
                condition:
                  lambda: "return id(kb_last_alt) && (id(kb_last_raw) == 'r' || id(kb_last_raw) == 'R');"
                then:
                  - lvgl.page.show: reader_page
            - if:
                condition:
                  lambda: "return id(kb_last_alt) && (id(kb_last_raw) == 's' || id(kb_last_raw) == 'S');"
                then:
                  - lvgl.page.show: settings_page
            - if:
                condition:
                  lambda: "return id(kb_last_alt) && (id(kb_last_raw) == 't' || id(kb_last_raw) == 'T');"
                then:
                  - lvgl.page.show: theme_page
            - if:
                condition:
                  lambda: "return id(kb_last_alt) && (id(kb_last_raw) == 'k' || id(kb_last_raw) == 'K');"
                then:
                  - script.execute: open_shortcuts
            - if:
                condition:
                  lambda: "return id(kb_last_alt) && (id(kb_last_raw) == 'q' || id(kb_last_raw) == 'Q');"
                then:
                  - script.execute: page_prev
            - if:
                condition:
                  lambda: "return id(kb_last_alt) && (id(kb_last_raw) == 'e' || id(kb_last_raw) == 'E');"
                then:
                  - script.execute: page_next

            - if:
                condition:
                  lambda: "return id(kb_last_alt) && (id(kb_last_raw) == 'd' || id(kb_last_raw) == 'D');"
                then:
                  - script.execute: selected_light_prev
            - if:
                condition:
                  lambda: "return id(kb_last_alt) && (id(kb_last_raw) == 'f' || id(kb_last_raw) == 'F');"
                then:
                  - script.execute: selected_light_next
            - if:
                condition:
                  lambda: "return id(kb_last_alt) && (id(kb_last_raw) == 'z' || id(kb_last_raw) == 'Z');"
                then:
                  - script.execute: selected_light_dimmer
            - if:
                condition:
                  lambda: "return id(kb_last_alt) && (id(kb_last_raw) == 'x' || id(kb_last_raw) == 'X');"
                then:
                  - script.execute: selected_light_brighter
            - if:
                condition:
                  lambda: "return id(kb_last_alt) && (id(kb_last_raw) == 'g' || id(kb_last_raw) == 'G');"
                then:
                  - script.execute: selected_light_toggle
            - if:
                condition:
                  lambda: "return id(kb_last_alt) && (id(kb_last_raw) == 'p' || id(kb_last_raw) == 'P');"
                then:
                  - script.execute: open_light_colors
            - if:
                condition:
                  lambda: "return id(kb_last_alt) && id(kb_last_raw) == '0';"
                then:
                  - script.execute: all_lights_off
            - if:
                condition:
                  lambda: "return id(kb_last_alt) && (id(kb_last_raw) == 'n' || id(kb_last_raw) == 'N');"
                then:
                  - script.execute: selected_light_warm
            - if:
                condition:
                  lambda: "return id(kb_last_alt) && (id(kb_last_raw) == 'm' || id(kb_last_raw) == 'M');"
                then:
                  - script.execute: selected_light_cool

            - if:
                condition:
                  lambda: "return id(kb_last_alt) && (id(kb_last_raw) == 'y' || id(kb_last_raw) == 'Y');"
                then:
                  - script.execute: start_touch_calibration
            - if:
                condition:
                  lambda: "return id(kb_last_alt) && (id(kb_last_raw) == 'v' || id(kb_last_raw) == 'V');"
                then:
                  - script.execute: reset_touch_calibration
            - if:
                condition:
                  lambda: "return id(kb_last_alt) && (id(kb_last_raw) == 'j' || id(kb_last_raw) == 'J');"
                then:
                  - script.execute: touch_cal_save
            - if:
                condition:
                  lambda: "return id(kb_last_alt) && (id(kb_last_raw) == 'u' || id(kb_last_raw) == 'U');"
                then:
                  - script.execute: touch_cal_retry
            - if:
                condition:
                  lambda: "return id(kb_last_alt) && (id(kb_last_raw) == 'i' || id(kb_last_raw) == 'I');"
                then:
                  - script.execute: theme_icon_mode_toggle
            - if:
                condition:
                  lambda: "return id(kb_last_alt) && (id(kb_last_raw) == 'o' || id(kb_last_raw) == 'O');"
                then:
                  - script.execute: toggle_touch_debug

            - lambda: |-
                id(kb_last_raw) = 0;
                id(kb_last_alt) = false;
