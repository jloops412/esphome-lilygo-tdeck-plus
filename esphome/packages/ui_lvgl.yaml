
script:
  - id: note_activity
    then:
      - lambda: |-
          uint32_t now = esphome::millis();
          if (!id(screensaver_active)) {
            // Ignore very-frequent activity pulses to prevent noisy inputs
            // from blocking auto-screensaver.
            if ((now - id(last_activity_note_ms)) < 1500) {
              return;
            }
          }
          id(last_activity_note_ms) = now;
          id(last_activity_ms) = now;
      - if:
          condition:
            lambda: "return id(screensaver_active);"
          then:
            - script.execute: wake_display

  - id: page_next
    then:
      - lvgl.page.next:
      - script.execute: lvgl_update_dynamic

  - id: page_prev
    then:
      - lvgl.page.previous:
      - script.execute: lvgl_update_dynamic

  - id: wake_display
    then:
      - lambda: |-
          uint32_t now = esphome::millis();
          id(screensaver_active) = false;
          id(last_activity_ms) = now;
          id(last_activity_note_ms) = now;
      - light.turn_on:
          id: tft_backlight
          brightness: !lambda "return id(backlight_percent) / 100.0f;"
      - script.execute: kb_backlight_apply
      - lvgl.resume:
      - script.execute: lvgl_update_dynamic

  - id: sleep_display
    then:
      - lambda: |-
          id(screensaver_active) = true;
      - lvgl.pause:
          show_snow: false
      - light.turn_off: tft_backlight

  - id: kb_backlight_apply
    then:
      - lambda: |-
          int pct = id(kb_backlight_percent);
          if (pct < 0) pct = 0;
          if (pct > 100) pct = 100;

          int live = (pct * 255) / 100;
          int remembered = id(kb_backlight_last_nonzero);
          if (remembered < 20) remembered = 20;
          if (remembered > 100) remembered = 100;
          int defv = (remembered * 255) / 100;
          if (pct > 0) {
            defv = live;
            if (defv < 40) defv = 40;
          }

          uint8_t cmd_default[2] = {0x02, (uint8_t)defv};
          uint8_t cmd_live[2] = {0x01, (uint8_t)live};

          int profile = id(kb_backlight_profile);
          if (profile < 0 || profile > 2) profile = 0;

          // Profile 0: default -> live (current stable preference)
          // Profile 1: live -> default (some keyboard MCU revisions react better)
          // Profile 2: live-only pulse
          for (int i = 0; i < 4; i++) {
            if (profile == 1) {
              id(bus_a).write(0x55, cmd_live, 2);
              delay(3);
              id(bus_a).write(0x55, cmd_default, 2);
            } else if (profile == 2) {
              id(bus_a).write(0x55, cmd_live, 2);
            } else {
              id(bus_a).write(0x55, cmd_default, 2);
              delay(3);
              id(bus_a).write(0x55, cmd_live, 2);
            }
            delay(3);
          }

  - id: kb_backlight_profile_next
    then:
      - lambda: |-
          id(kb_backlight_profile) = (id(kb_backlight_profile) + 1) % 3;
      - script.execute: kb_backlight_apply
      - script.execute: lvgl_update_dynamic

  - id: kb_backlight_toggle
    then:
      - lambda: |-
          if (id(kb_backlight_percent) > 0) {
            id(kb_backlight_last_nonzero) = id(kb_backlight_percent);
            id(kb_backlight_percent) = 0;
          } else {
            if (id(kb_backlight_last_nonzero) <= 0) id(kb_backlight_last_nonzero) = 70;
            id(kb_backlight_percent) = id(kb_backlight_last_nonzero);
          }
      - script.execute: kb_backlight_apply
      - script.execute: lvgl_update_dynamic

  - id: kb_backlight_down
    then:
      - lambda: |-
          id(kb_backlight_percent) -= 20;
          if (id(kb_backlight_percent) < 0) id(kb_backlight_percent) = 0;
          if (id(kb_backlight_percent) > 0) id(kb_backlight_last_nonzero) = id(kb_backlight_percent);
      - script.execute: kb_backlight_apply
      - script.execute: lvgl_update_dynamic

  - id: kb_backlight_up
    then:
      - lambda: |-
          id(kb_backlight_percent) += 20;
          if (id(kb_backlight_percent) > 100) id(kb_backlight_percent) = 100;
          if (id(kb_backlight_percent) > 0) id(kb_backlight_last_nonzero) = id(kb_backlight_percent);
      - script.execute: kb_backlight_apply
      - script.execute: lvgl_update_dynamic

  - id: saver_timeout_down
    then:
      - lambda: |-
          id(screensaver_timeout_s) -= 5;
          if (id(screensaver_timeout_s) < 10) id(screensaver_timeout_s) = 10;
      - script.execute: lvgl_update_dynamic

  - id: saver_timeout_up
    then:
      - lambda: |-
          id(screensaver_timeout_s) += 5;
          if (id(screensaver_timeout_s) > 300) id(screensaver_timeout_s) = 300;
      - script.execute: lvgl_update_dynamic

  - id: set_saver_timeout
    parameters:
      seconds: int
    then:
      - lambda: |-
          seconds = ((seconds + 2) / 5) * 5;
          if (seconds < 10) seconds = 10;
          if (seconds > 300) seconds = 300;
          id(screensaver_timeout_s) = seconds;
      - lvgl.slider.update:
          id: settings_saver_slider
          value: !lambda "return id(screensaver_timeout_s);"
      - script.execute: lvgl_update_dynamic

  - id: toggle_wake_touch
    then:
      - lambda: |-
          id(wake_on_touch) = !id(wake_on_touch);
      - script.execute: lvgl_update_dynamic

  - id: toggle_wake_keyboard
    then:
      - lambda: |-
          id(wake_on_keyboard) = !id(wake_on_keyboard);
      - script.execute: lvgl_update_dynamic

  - id: toggle_wake_trackball
    then:
      - lambda: |-
          id(wake_on_trackball) = !id(wake_on_trackball);
      - script.execute: lvgl_update_dynamic

  - id: toggle_touch_debug
    then:
      - lambda: |-
          id(touch_debug) = !id(touch_debug);
      - script.execute: lvgl_update_dynamic

  - id: start_touch_calibration
    then:
      - lambda: |-
          id(touch_cal_mode) = true;
          id(touch_cal_review_pending) = false;
          id(touch_cal_step) = 0;
          id(touch_active) = false;
          id(touch_cal_candidate_x_min) = 0;
          id(touch_cal_candidate_x_max) = 0;
          id(touch_cal_candidate_y_min) = 0;
          id(touch_cal_candidate_y_max) = 0;
          id(cal_raw_tl_x) = 0; id(cal_raw_tl_y) = 0;
          id(cal_raw_tr_x) = 0; id(cal_raw_tr_y) = 0;
          id(cal_raw_bl_x) = 0; id(cal_raw_bl_y) = 0;
          id(cal_raw_br_x) = 0; id(cal_raw_br_y) = 0;
          id(cal9_raw_tl_x) = 0; id(cal9_raw_tl_y) = 0;
          id(cal9_raw_tc_x) = 0; id(cal9_raw_tc_y) = 0;
          id(cal9_raw_tr_x) = 0; id(cal9_raw_tr_y) = 0;
          id(cal9_raw_ml_x) = 0; id(cal9_raw_ml_y) = 0;
          id(cal9_raw_mc_x) = 0; id(cal9_raw_mc_y) = 0;
          id(cal9_raw_mr_x) = 0; id(cal9_raw_mr_y) = 0;
          id(cal9_raw_bl_x) = 0; id(cal9_raw_bl_y) = 0;
          id(cal9_raw_bc_x) = 0; id(cal9_raw_bc_y) = 0;
          id(cal9_raw_br_x) = 0; id(cal9_raw_br_y) = 0;
      - lvgl.page.show: touch_cal_page
      - script.execute: lvgl_update_dynamic

  - id: reset_touch_calibration
    then:
      - lambda: |-
          id(cal_dx_tl) = 0; id(cal_dy_tl) = 0;
          id(cal_dx_tc) = 0; id(cal_dy_tc) = 0;
          id(cal_dx_tr) = 0; id(cal_dy_tr) = 0;
          id(cal_dx_ml) = 0; id(cal_dy_ml) = 0;
          id(cal_dx_mc) = 0; id(cal_dy_mc) = 0;
          id(cal_dx_mr) = 0; id(cal_dy_mr) = 0;
          id(cal_dx_bl) = 0; id(cal_dy_bl) = 0;
          id(cal_dx_bc) = 0; id(cal_dy_bc) = 0;
          id(cal_dx_br) = 0; id(cal_dy_br) = 0;
          id(cal_raw_tl_x) = 0; id(cal_raw_tl_y) = 0;
          id(cal_raw_tr_x) = 0; id(cal_raw_tr_y) = 0;
          id(cal_raw_bl_x) = 0; id(cal_raw_bl_y) = 0;
          id(cal_raw_br_x) = 0; id(cal_raw_br_y) = 0;
          id(cal9_raw_tl_x) = 0; id(cal9_raw_tl_y) = 0;
          id(cal9_raw_tc_x) = 0; id(cal9_raw_tc_y) = 0;
          id(cal9_raw_tr_x) = 0; id(cal9_raw_tr_y) = 0;
          id(cal9_raw_ml_x) = 0; id(cal9_raw_ml_y) = 0;
          id(cal9_raw_mc_x) = 0; id(cal9_raw_mc_y) = 0;
          id(cal9_raw_mr_x) = 0; id(cal9_raw_mr_y) = 0;
          id(cal9_raw_bl_x) = 0; id(cal9_raw_bl_y) = 0;
          id(cal9_raw_bc_x) = 0; id(cal9_raw_bc_y) = 0;
          id(cal9_raw_br_x) = 0; id(cal9_raw_br_y) = 0;
          id(touch_cal_candidate_x_min) = 0;
          id(touch_cal_candidate_x_max) = 0;
          id(touch_cal_candidate_y_min) = 0;
          id(touch_cal_candidate_y_max) = 0;
          id(touch_cal_mode) = false;
          id(touch_cal_review_pending) = false;
          id(touch_cal_step) = 0;
      - lambda: |-
          id(touch_cal_suggest_x_min) = atoi("${touch_x_min}");
          id(touch_cal_suggest_x_max) = atoi("${touch_x_max}");
          id(touch_cal_suggest_y_min) = atoi("${touch_y_min}");
          id(touch_cal_suggest_y_max) = atoi("${touch_y_max}");
      - script.execute: touch_cal_apply_stored
      - script.execute: lvgl_update_dynamic

  - id: touch_cal_save
    then:
      - if:
          condition:
            lambda: "return id(touch_cal_review_pending);"
          then:
            - lambda: |-
                id(touch_cal_suggest_x_min) = id(touch_cal_candidate_x_min);
                id(touch_cal_suggest_x_max) = id(touch_cal_candidate_x_max);
                id(touch_cal_suggest_y_min) = id(touch_cal_candidate_y_min);
                id(touch_cal_suggest_y_max) = id(touch_cal_candidate_y_max);
                id(touch_cal_review_pending) = false;
            - script.execute: touch_cal_apply_stored
            - lvgl.page.show: settings_page
      - script.execute: lvgl_update_dynamic

  - id: touch_cal_retry
    then:
      - script.execute: start_touch_calibration

  - id: touch_cal_apply_stored
    then:
      - lambda: |-
          if (id(touch_cal_suggest_x_max) > id(touch_cal_suggest_x_min) &&
              id(touch_cal_suggest_y_max) > id(touch_cal_suggest_y_min)) {
            id(tdeck_touch).set_calibration(
              id(touch_cal_suggest_x_min),
              id(touch_cal_suggest_x_max),
              id(touch_cal_suggest_y_min),
              id(touch_cal_suggest_y_max)
            );
            ESP_LOGI("touch_cal", "Using persisted calibration x_min=%d x_max=%d y_min=%d y_max=%d",
                     id(touch_cal_suggest_x_min),
                     id(touch_cal_suggest_x_max),
                     id(touch_cal_suggest_y_min),
                     id(touch_cal_suggest_y_max));
          }

  - id: select_light
    parameters:
      idx: int
    then:
      - lambda: |-
          if (idx < 0) idx = 0;
          if (idx > 5) idx = 5;
          id(selected_light) = idx;
      - script.execute: lvgl_update_dynamic

  - id: display_backlight_down
    then:
      - lambda: |-
          id(backlight_percent) -= 10;
          if (id(backlight_percent) < 10) id(backlight_percent) = 10;
      - light.turn_on:
          id: tft_backlight
          brightness: !lambda "return id(backlight_percent) / 100.0f;"
      - script.execute: lvgl_update_dynamic

  - id: display_backlight_up
    then:
      - lambda: |-
          id(backlight_percent) += 10;
          if (id(backlight_percent) > 100) id(backlight_percent) = 100;
      - light.turn_on:
          id: tft_backlight
          brightness: !lambda "return id(backlight_percent) / 100.0f;"
      - script.execute: lvgl_update_dynamic

  - id: set_display_backlight
    parameters:
      pct: int
    then:
      - lambda: |-
          pct = ((pct + 2) / 5) * 5;
          if (pct < 10) pct = 10;
          if (pct > 100) pct = 100;
          id(backlight_percent) = pct;
      - light.turn_on:
          id: tft_backlight
          brightness: !lambda "return id(backlight_percent) / 100.0f;"
      - lvgl.slider.update:
          id: display_brightness_slider
          value: !lambda "return id(backlight_percent);"
      - script.execute: lvgl_update_dynamic

  - id: set_kb_backlight
    parameters:
      pct: int
    then:
      - lambda: |-
          pct = ((pct + 2) / 5) * 5;
          if (pct < 0) pct = 0;
          if (pct > 100) pct = 100;
          id(kb_backlight_percent) = pct;
          if (pct > 0) id(kb_backlight_last_nonzero) = pct;
      - script.execute: kb_backlight_apply
      - lvgl.slider.update:
          id: kb_brightness_slider
          value: !lambda "return id(kb_backlight_percent);"
      - script.execute: lvgl_update_dynamic

  - id: selected_light_prev
    then:
      - lambda: |-
          id(selected_light) = (id(selected_light) + 5) % 6;
      - script.execute: lvgl_update_dynamic

  - id: selected_light_next
    then:
      - lambda: |-
          id(selected_light) = (id(selected_light) + 1) % 6;
      - script.execute: lvgl_update_dynamic

  - id: selected_light_toggle
    then:
      - homeassistant.action:
          action: light.toggle
          data:
            entity_id: !lambda |-
              switch (id(selected_light)) {
                case 0: return std::string("${entity_light_foyer}");
                case 1: return std::string("${entity_light_vanity}");
                case 2: return std::string("${entity_light_bedroom}");
                case 3: return std::string("${entity_light_hall}");
                case 4: return std::string("${entity_light_office}");
                default: return std::string("${entity_light_upstairs}");
              }
      - script.execute: lvgl_update_dynamic

  - id: selected_light_brighter
    then:
      - lambda: |-
          id(selected_light_brightness_pct) += 20;
          if (id(selected_light_brightness_pct) > 100) id(selected_light_brightness_pct) = 100;
      - homeassistant.action:
          action: light.turn_on
          data:
            entity_id: !lambda |-
              switch (id(selected_light)) {
                case 0: return std::string("${entity_light_foyer}");
                case 1: return std::string("${entity_light_vanity}");
                case 2: return std::string("${entity_light_bedroom}");
                case 3: return std::string("${entity_light_hall}");
                case 4: return std::string("${entity_light_office}");
                default: return std::string("${entity_light_upstairs}");
              }
            brightness_step_pct: "20"
      - script.execute: lvgl_update_dynamic

  - id: selected_light_dimmer
    then:
      - lambda: |-
          id(selected_light_brightness_pct) -= 20;
          if (id(selected_light_brightness_pct) < 1) id(selected_light_brightness_pct) = 1;
      - homeassistant.action:
          action: light.turn_on
          data:
            entity_id: !lambda |-
              switch (id(selected_light)) {
                case 0: return std::string("${entity_light_foyer}");
                case 1: return std::string("${entity_light_vanity}");
                case 2: return std::string("${entity_light_bedroom}");
                case 3: return std::string("${entity_light_hall}");
                case 4: return std::string("${entity_light_office}");
                default: return std::string("${entity_light_upstairs}");
              }
            brightness_step_pct: "-20"
      - script.execute: lvgl_update_dynamic

  - id: selected_light_set_brightness_pct
    parameters:
      pct: int
    then:
      - lambda: |-
          pct = ((pct + 2) / 5) * 5;
          if (pct < 1) pct = 1;
          if (pct > 100) pct = 100;
          id(selected_light_brightness_pct) = pct;
      - homeassistant.action:
          action: light.turn_on
          data:
            entity_id: !lambda |-
              switch (id(selected_light)) {
                case 0: return std::string("${entity_light_foyer}");
                case 1: return std::string("${entity_light_vanity}");
                case 2: return std::string("${entity_light_bedroom}");
                case 3: return std::string("${entity_light_hall}");
                case 4: return std::string("${entity_light_office}");
                default: return std::string("${entity_light_upstairs}");
              }
            brightness_pct: !lambda |-
              char buf[8];
              snprintf(buf, sizeof(buf), "%d", id(selected_light_brightness_pct));
              return std::string(buf);
      - lvgl.slider.update:
          id: light_brightness_slider
          value: !lambda "return id(selected_light_brightness_pct);"
      - script.execute: lvgl_update_dynamic

  - id: selected_light_warm
    then:
      - lambda: |-
          id(selected_light_kelvin) = 2700;
      - homeassistant.action:
          action: light.turn_on
          data:
            entity_id: !lambda |-
              switch (id(selected_light)) {
                case 0: return std::string("${entity_light_foyer}");
                case 1: return std::string("${entity_light_vanity}");
                case 2: return std::string("${entity_light_bedroom}");
                case 3: return std::string("${entity_light_hall}");
                case 4: return std::string("${entity_light_office}");
                default: return std::string("${entity_light_upstairs}");
              }
            color_temp_kelvin: "2700"
      - script.execute: lvgl_update_dynamic

  - id: selected_light_cool
    then:
      - lambda: |-
          id(selected_light_kelvin) = 6500;
      - homeassistant.action:
          action: light.turn_on
          data:
            entity_id: !lambda |-
              switch (id(selected_light)) {
                case 0: return std::string("${entity_light_foyer}");
                case 1: return std::string("${entity_light_vanity}");
                case 2: return std::string("${entity_light_bedroom}");
                case 3: return std::string("${entity_light_hall}");
                case 4: return std::string("${entity_light_office}");
                default: return std::string("${entity_light_upstairs}");
              }
            color_temp_kelvin: "6500"
      - script.execute: lvgl_update_dynamic

  - id: selected_light_color
    parameters:
      cname: string
    then:
      - homeassistant.action:
          action: light.turn_on
          data:
            entity_id: !lambda |-
              switch (id(selected_light)) {
                case 0: return std::string("${entity_light_foyer}");
                case 1: return std::string("${entity_light_vanity}");
                case 2: return std::string("${entity_light_bedroom}");
                case 3: return std::string("${entity_light_hall}");
                case 4: return std::string("${entity_light_office}");
                default: return std::string("${entity_light_upstairs}");
              }
            color_name: !lambda "return cname;"
      - script.execute: lvgl_update_dynamic

  - id: selected_light_preset_cycle
    then:
      - lambda: |-
          id(light_preset_index) = (id(light_preset_index) + 1) % 5;
      - if:
          condition:
            lambda: "return id(light_preset_index) == 0;"
          then:
            - script.execute: selected_light_warm
      - if:
          condition:
            lambda: "return id(light_preset_index) == 1;"
          then:
            - script.execute: selected_light_cool
      - if:
          condition:
            lambda: "return id(light_preset_index) == 2;"
          then:
            - script.execute:
                id: selected_light_color
                cname: "orange"
      - if:
          condition:
            lambda: "return id(light_preset_index) == 3;"
          then:
            - script.execute:
                id: selected_light_color
                cname: "white"
      - if:
          condition:
            lambda: "return id(light_preset_index) == 4;"
          then:
            - script.execute:
                id: selected_light_color
                cname: "purple"
      - script.execute: lvgl_update_dynamic

  - id: theme_prev
    then:
      - lambda: |-
          id(theme_index) = (id(theme_index) + 4) % 5;
      - script.execute: apply_theme

  - id: theme_next
    then:
      - lambda: |-
          id(theme_index) = (id(theme_index) + 1) % 5;
      - script.execute: apply_theme

  - id: apply_theme
    then:
      - if:
          condition:
            lambda: "return id(theme_index) == 0;"
          then:
            - lvgl.style.update:
                id: lv_style_screen
                bg_color: 0x090D12
                text_color: 0xF2F5FA
            - lvgl.style.update:
                id: lv_style_card
                bg_color: 0x131A24
                border_color: 0x2A3647
            - lvgl.style.update:
                id: lv_style_btn
                bg_color: 0x1B2533
                border_color: 0x4A6B93
                text_color: 0xF2F5FA
            - lvgl.style.update:
                id: lv_style_btn_soft
                bg_color: 0x151E2A
                border_color: 0x34475F
                text_color: 0xDFE8F3
            - lvgl.style.update:
                id: lv_style_btn_warn
                bg_color: 0x2F1D22
                border_color: 0x7B4A57
                text_color: 0xFDEEF2
            - lvgl.style.update:
                id: lv_style_btn_ok
                bg_color: 0x1C2B24
                border_color: 0x4A7B62
                text_color: 0xE9F8EF
      - if:
          condition:
            lambda: "return id(theme_index) == 1;"
          then:
            - lvgl.style.update:
                id: lv_style_screen
                bg_color: 0x091017
                text_color: 0xEAF3FA
            - lvgl.style.update:
                id: lv_style_card
                bg_color: 0x102131
                border_color: 0x2D4C68
            - lvgl.style.update:
                id: lv_style_btn
                bg_color: 0x173149
                border_color: 0x4A7CA6
                text_color: 0xEAF3FA
            - lvgl.style.update:
                id: lv_style_btn_soft
                bg_color: 0x132A3F
                border_color: 0x3B6184
                text_color: 0xDDEAF7
            - lvgl.style.update:
                id: lv_style_btn_warn
                bg_color: 0x2E2420
                border_color: 0x7C5B4D
                text_color: 0xF8ECE4
            - lvgl.style.update:
                id: lv_style_btn_ok
                bg_color: 0x17312D
                border_color: 0x3E7B73
                text_color: 0xE6F7F4
      - if:
          condition:
            lambda: "return id(theme_index) == 2;"
          then:
            - lvgl.style.update:
                id: lv_style_screen
                bg_color: 0x140F0A
                text_color: 0xFDF1E4
            - lvgl.style.update:
                id: lv_style_card
                bg_color: 0x241A12
                border_color: 0x705638
            - lvgl.style.update:
                id: lv_style_btn
                bg_color: 0x352518
                border_color: 0x8B663F
                text_color: 0xFDF1E4
            - lvgl.style.update:
                id: lv_style_btn_soft
                bg_color: 0x2C2015
                border_color: 0x6F5235
                text_color: 0xF5E6D5
            - lvgl.style.update:
                id: lv_style_btn_warn
                bg_color: 0x3A231E
                border_color: 0x8A4A3F
                text_color: 0xFAECE8
            - lvgl.style.update:
                id: lv_style_btn_ok
                bg_color: 0x2A2815
                border_color: 0x6D7140
                text_color: 0xF3F5E2
      - if:
          condition:
            lambda: "return id(theme_index) == 3;"
          then:
            - lvgl.style.update:
                id: lv_style_screen
                bg_color: 0x0D120F
                text_color: 0xEEF7F1
            - lvgl.style.update:
                id: lv_style_card
                bg_color: 0x16201A
                border_color: 0x3C5846
            - lvgl.style.update:
                id: lv_style_btn
                bg_color: 0x1C2D23
                border_color: 0x5A8B6C
                text_color: 0xEEF7F1
            - lvgl.style.update:
                id: lv_style_btn_soft
                bg_color: 0x19261E
                border_color: 0x466754
                text_color: 0xDDEDE3
            - lvgl.style.update:
                id: lv_style_btn_warn
                bg_color: 0x332522
                border_color: 0x835D50
                text_color: 0xFAEDE9
            - lvgl.style.update:
                id: lv_style_btn_ok
                bg_color: 0x1A3126
                border_color: 0x4C8768
                text_color: 0xE7F8EE
      - if:
          condition:
            lambda: "return id(theme_index) == 4;"
          then:
            - lvgl.style.update:
                id: lv_style_screen
                bg_color: 0x070808
                text_color: 0xF1F3F3
            - lvgl.style.update:
                id: lv_style_card
                bg_color: 0x111313
                border_color: 0x3A3F40
            - lvgl.style.update:
                id: lv_style_btn
                bg_color: 0x191B1C
                border_color: 0x6A7172
                text_color: 0xF1F3F3
            - lvgl.style.update:
                id: lv_style_btn_soft
                bg_color: 0x151718
                border_color: 0x4E5556
                text_color: 0xDDE2E2
            - lvgl.style.update:
                id: lv_style_btn_warn
                bg_color: 0x322626
                border_color: 0x7D5C5C
                text_color: 0xFAF0F0
            - lvgl.style.update:
                id: lv_style_btn_ok
                bg_color: 0x213126
                border_color: 0x59806B
                text_color: 0xE8F6EE
      - script.execute: lvgl_update_dynamic

  - id: open_detail_bbc
    then:
      - lambda: |-
          id(detail_source) = 0;
      - script.execute: refresh_detail_page
      - lvgl.page.show: detail_page

  - id: open_detail_dc
    then:
      - lambda: |-
          id(detail_source) = 1;
      - script.execute: refresh_detail_page
      - lvgl.page.show: detail_page

  - id: open_detail_loudoun
    then:
      - lambda: |-
          id(detail_source) = 2;
      - script.execute: refresh_detail_page
      - lvgl.page.show: detail_page

  - id: open_detail_word
    then:
      - lambda: |-
          id(detail_source) = 3;
      - script.execute: refresh_detail_page
      - lvgl.page.show: detail_page

  - id: open_detail_quote
    then:
      - lambda: |-
          id(detail_source) = 4;
      - script.execute: refresh_detail_page
      - lvgl.page.show: detail_page

  - id: open_shortcuts
    then:
      - lvgl.page.show: shortcuts_page
      - script.execute: lvgl_update_dynamic

  - id: selected_light_set_kelvin
    parameters:
      kelvin: int
    then:
      - lambda: |-
          kelvin = ((kelvin + 50) / 100) * 100;
          if (kelvin < 2200) kelvin = 2200;
          if (kelvin > 6500) kelvin = 6500;
          id(selected_light_kelvin) = kelvin;
      - homeassistant.action:
          action: light.turn_on
          data:
            entity_id: !lambda |-
              switch (id(selected_light)) {
                case 0: return std::string("${entity_light_foyer}");
                case 1: return std::string("${entity_light_vanity}");
                case 2: return std::string("${entity_light_bedroom}");
                case 3: return std::string("${entity_light_hall}");
                case 4: return std::string("${entity_light_office}");
                default: return std::string("${entity_light_upstairs}");
              }
            color_temp_kelvin: !lambda |-
              char buf[12];
              snprintf(buf, sizeof(buf), "%d", id(selected_light_kelvin));
              return std::string(buf);
      - lvgl.slider.update:
          id: light_temp_slider
          value: !lambda "return id(selected_light_kelvin);"
      - script.execute: lvgl_update_dynamic

  - id: open_climate
    then:
      - lvgl.page.show: climate_page
      - script.execute: lvgl_update_dynamic

  - id: sensi_hvac_mode_off
    then:
      - homeassistant.action:
          action: climate.set_hvac_mode
          data:
            entity_id: ${entity_sensi_climate}
            hvac_mode: "off"
      - script.execute: lvgl_update_dynamic

  - id: sensi_hvac_mode_heat
    then:
      - homeassistant.action:
          action: climate.set_hvac_mode
          data:
            entity_id: ${entity_sensi_climate}
            hvac_mode: "heat"
      - script.execute: lvgl_update_dynamic

  - id: sensi_hvac_mode_cool
    then:
      - homeassistant.action:
          action: climate.set_hvac_mode
          data:
            entity_id: ${entity_sensi_climate}
            hvac_mode: "cool"
      - script.execute: lvgl_update_dynamic

  - id: sensi_hvac_mode_auto
    then:
      - homeassistant.action:
          action: climate.set_hvac_mode
          data:
            entity_id: ${entity_sensi_climate}
            hvac_mode: "auto"
      - script.execute: lvgl_update_dynamic

  - id: sensi_toggle_aux_heat
    then:
      - homeassistant.action:
          action: switch.toggle
          data:
            entity_id: ${entity_sensi_aux_heat_switch}
      - script.execute: lvgl_update_dynamic

  - id: sensi_toggle_display_humidity
    then:
      - homeassistant.action:
          action: switch.toggle
          data:
            entity_id: ${entity_sensi_display_humidity_switch}
      - script.execute: lvgl_update_dynamic

  - id: sensi_toggle_display_time
    then:
      - homeassistant.action:
          action: switch.toggle
          data:
            entity_id: ${entity_sensi_display_time_switch}
      - script.execute: lvgl_update_dynamic

  - id: sensi_toggle_fan_support
    then:
      - homeassistant.action:
          action: switch.toggle
          data:
            entity_id: ${entity_sensi_fan_support_switch}
      - script.execute: lvgl_update_dynamic

  - id: sensi_toggle_humidification
    then:
      - homeassistant.action:
          action: switch.toggle
          data:
            entity_id: ${entity_sensi_humidification_switch}
      - script.execute: lvgl_update_dynamic

  - id: sensi_toggle_keypad_lockout
    then:
      - homeassistant.action:
          action: switch.toggle
          data:
            entity_id: ${entity_sensi_keypad_lockout_switch}
      - script.execute: lvgl_update_dynamic

  - id: sensi_set_heat_target
    parameters:
      val: int
    then:
      - lambda: |-
          if (val < 50) val = 50;
          if (val > 90) val = 90;
      - homeassistant.action:
          action: number.set_value
          data:
            entity_id: ${entity_sensi_auto_heat_number}
            value: !lambda |-
              char buf[12];
              snprintf(buf, sizeof(buf), "%d", val);
              return std::string(buf);
      - script.execute: lvgl_update_dynamic

  - id: sensi_set_cool_target
    parameters:
      val: int
    then:
      - lambda: |-
          if (val < 50) val = 50;
          if (val > 95) val = 95;
      - homeassistant.action:
          action: number.set_value
          data:
            entity_id: ${entity_sensi_auto_cool_number}
            value: !lambda |-
              char buf[12];
              snprintf(buf, sizeof(buf), "%d", val);
              return std::string(buf);
      - script.execute: lvgl_update_dynamic

  - id: sensi_set_humidity_offset
    parameters:
      val: int
    then:
      - lambda: |-
          if (val < -20) val = -20;
          if (val > 20) val = 20;
      - homeassistant.action:
          action: number.set_value
          data:
            entity_id: ${entity_sensi_humidity_offset_number}
            value: !lambda |-
              char buf[16];
              snprintf(buf, sizeof(buf), "%d", val);
              return std::string(buf);
      - script.execute: lvgl_update_dynamic

  - id: sensi_set_temperature_offset
    parameters:
      val: int
    then:
      - lambda: |-
          if (val < -10) val = -10;
          if (val > 10) val = 10;
      - homeassistant.action:
          action: number.set_value
          data:
            entity_id: ${entity_sensi_temperature_offset_number}
            value: !lambda |-
              char buf[16];
              snprintf(buf, sizeof(buf), "%d", val);
              return std::string(buf);
      - script.execute: lvgl_update_dynamic

  - id: refresh_detail_page
    then:
      - lvgl.label.update:
          id: detail_title_lbl
          text: !lambda |-
            if (id(detail_source) == 0) return std::string("BBC");
            if (id(detail_source) == 1) return std::string("DC");
            if (id(detail_source) == 2) return std::string("Loudoun");
            if (id(detail_source) == 3) return std::string("Word of the Day");
            return std::string("Quote of the Hour");
      - lvgl.label.update:
          id: detail_body_lbl
          text: !lambda |-
            if (id(detail_source) == 0) {
              if (id(feed_bbc_title).has_state() && !id(feed_bbc_title).state.empty()) return id(feed_bbc_title).state;
              if (id(feed_bbc_message).has_state() && !id(feed_bbc_message).state.empty()) return id(feed_bbc_message).state;
              if (id(feed_bbc_state).has_state()) return id(feed_bbc_state).state;
            }
            if (id(detail_source) == 1) {
              if (id(feed_dc_title).has_state() && !id(feed_dc_title).state.empty()) return id(feed_dc_title).state;
              if (id(feed_dc_message).has_state() && !id(feed_dc_message).state.empty()) return id(feed_dc_message).state;
              if (id(feed_dc_state).has_state()) return id(feed_dc_state).state;
            }
            if (id(detail_source) == 2) {
              if (id(feed_loudoun_title).has_state() && !id(feed_loudoun_title).state.empty()) return id(feed_loudoun_title).state;
              if (id(feed_loudoun_message).has_state() && !id(feed_loudoun_message).state.empty()) return id(feed_loudoun_message).state;
              if (id(feed_loudoun_state).has_state()) return id(feed_loudoun_state).state;
            }
            if (id(detail_source) == 3 && id(word_of_day).has_state()) return id(word_of_day).state;
            if (id(detail_source) == 4 && id(quote_of_hour).has_state()) return id(quote_of_hour).state;
            return std::string("No readable content available.");

  - id: lvgl_update_dynamic
    then:
      - lvgl.label.update:
          id: home_status_lbl
          text: !lambda |-
            char buf[160];
            float sats = id(gps_satellites).state;
            if (!id(gps_data_alive).state) {
              snprintf(buf, sizeof(buf), "Batt %.0f%%  WiFi %.0fdBm  GPS NO DATA  |  Alt+K keys", id(battery_percent).state, id(wifi_signal_tdeck).state);
            } else if (sats > 0.0f) {
              snprintf(buf, sizeof(buf), "Batt %.0f%%  WiFi %.0fdBm  GPS %.0f sat  |  Alt+K keys", id(battery_percent).state, id(wifi_signal_tdeck).state, sats);
            } else {
              snprintf(buf, sizeof(buf), "Batt %.0f%%  WiFi %.0fdBm  GPS searching  |  Alt+K keys", id(battery_percent).state, id(wifi_signal_tdeck).state);
            }
            return std::string(buf);
      - lvgl.label.update:
          id: lights_selected_lbl
          text: !lambda |-
            auto name = std::string("Upstairs");
            if (id(selected_light) == 0) name = "Foyer";
            else if (id(selected_light) == 1) name = "Vanity";
            else if (id(selected_light) == 2) name = "Bedroom";
            else if (id(selected_light) == 3) name = "Hall";
            else if (id(selected_light) == 4) name = "Office";

            auto state = std::string("-");
            if (id(selected_light) == 0 && id(foyer_state).has_state()) state = id(foyer_state).state;
            else if (id(selected_light) == 1 && id(vanity_state).has_state()) state = id(vanity_state).state;
            else if (id(selected_light) == 2 && id(bedroom_state).has_state()) state = id(bedroom_state).state;
            else if (id(selected_light) == 3 && id(hall_state).has_state()) state = id(hall_state).state;
            else if (id(selected_light) == 4 && id(office_state).has_state()) state = id(office_state).state;
            else if (id(selected_light) == 5 && id(upstairs_state).has_state()) state = id(upstairs_state).state;

            return std::string("Selected: ") + name + "  [" + state + "]";
      - lvgl.label.update:
          id: light_foyer_lbl
          text: !lambda |-
            std::string s = id(foyer_state).has_state() ? id(foyer_state).state : "-";
            std::string p = (id(selected_light) == 0) ? "> " : "  ";
            return p + std::string("Foyer ") + s;
      - lvgl.label.update:
          id: light_vanity_lbl
          text: !lambda |-
            std::string s = id(vanity_state).has_state() ? id(vanity_state).state : "-";
            std::string p = (id(selected_light) == 1) ? "> " : "  ";
            return p + std::string("Vanity ") + s;
      - lvgl.label.update:
          id: light_bedroom_lbl
          text: !lambda |-
            std::string s = id(bedroom_state).has_state() ? id(bedroom_state).state : "-";
            std::string p = (id(selected_light) == 2) ? "> " : "  ";
            return p + std::string("Bed ") + s;
      - lvgl.label.update:
          id: light_hall_lbl
          text: !lambda |-
            std::string s = id(hall_state).has_state() ? id(hall_state).state : "-";
            std::string p = (id(selected_light) == 3) ? "> " : "  ";
            return p + std::string("Hall ") + s;
      - lvgl.label.update:
          id: light_office_lbl
          text: !lambda |-
            std::string s = id(office_state).has_state() ? id(office_state).state : "-";
            std::string p = (id(selected_light) == 4) ? "> " : "  ";
            return p + std::string("Office ") + s;
      - lvgl.label.update:
          id: light_upstairs_lbl
          text: !lambda |-
            std::string s = id(upstairs_state).has_state() ? id(upstairs_state).state : "-";
            std::string p = (id(selected_light) == 5) ? "> " : "  ";
            return p + std::string("Upstairs ") + s;
      - lvgl.label.update:
          id: lights_preset_lbl
          text: !lambda |-
            if (id(light_preset_index) == 0) return std::string("Preset: Warm");
            if (id(light_preset_index) == 1) return std::string("Preset: Cool");
            if (id(light_preset_index) == 2) return std::string("Preset: Relax");
            if (id(light_preset_index) == 3) return std::string("Preset: Focus");
            return std::string("Preset: Party");
      - lvgl.label.update:
          id: lights_brightness_lbl
          text: !lambda |-
            char buf[32];
            snprintf(buf, sizeof(buf), "Brightness %d%%", id(selected_light_brightness_pct));
            return std::string(buf);
      - lvgl.label.update:
          id: lights_kelvin_lbl
          text: !lambda |-
            char buf[32];
            snprintf(buf, sizeof(buf), "Color Temp %dK", id(selected_light_kelvin));
            return std::string(buf);
      - lvgl.slider.update:
          id: light_brightness_slider
          value: !lambda "return id(selected_light_brightness_pct);"
      - lvgl.slider.update:
          id: light_temp_slider
          value: !lambda "return id(selected_light_kelvin);"
      - lvgl.label.update:
          id: weather_temp_lbl
          text: !lambda |-
            float temp = id(wx_temp).state;
            if (temp != temp) temp = id(wx_entity_temperature).state;
            if (temp != temp) return std::string("--");
            char buf[24];
            snprintf(buf, sizeof(buf), "Temp %.1f", temp);
            return std::string(buf);
      - lvgl.label.update:
          id: weather_cond_lbl
          text: !lambda |-
            if (id(wx_weather).has_state() && !id(wx_weather).state.empty()) return id(wx_weather).state;
            if (id(wx_condition).has_state() && !id(wx_condition).state.empty()) return id(wx_condition).state;
            if (id(wx_entity_state).has_state() && !id(wx_entity_state).state.empty()) return id(wx_entity_state).state;
            return std::string("-");
      - lvgl.label.update:
          id: weather_feels_lbl
          text: !lambda |-
            float feels = id(wx_feels).state;
            if (feels != feels) feels = id(wx_entity_temperature).state;
            if (feels != feels) return std::string("Feels --");
            char buf[28];
            snprintf(buf, sizeof(buf), "Feels %.1f", feels);
            return std::string(buf);
      - lvgl.label.update:
          id: weather_metrics_lbl
          text: !lambda |-
            char buf[220];
            float hum = id(wx_humidity).state;
            if (hum != hum) hum = id(wx_entity_humidity).state;
            if (hum != hum) hum = 0;
            float wind = id(wx_wind_speed).state;
            if (wind != wind) wind = id(wx_entity_wind_speed).state;
            if (wind != wind) wind = 0;
            float uv = id(wx_uv).state;
            if (uv != uv) uv = 0;
            float clouds = id(wx_clouds).state;
            if (clouds != clouds) clouds = id(wx_entity_cloud_coverage).state;
            if (clouds != clouds) clouds = 0;
            float press = id(wx_pressure).state;
            if (press != press) press = id(wx_entity_pressure).state;
            if (press != press) press = 0;
            float vis = id(wx_visibility).state;
            if (vis != vis) vis = id(wx_entity_visibility).state;
            if (vis != vis) vis = 0;
            float dew = id(wx_entity_dew_point).state;
            if (dew != dew) dew = 0;
            float bearing = id(wx_entity_wind_bearing).state;
            if (bearing != bearing) bearing = 0;
            snprintf(buf, sizeof(buf), "Hum %.0f%%  Wind %.0f @ %.0f deg  UV %.1f\nCloud %.0f%%  Press %.0f  Vis %.0f  Dew %.1f",
                     hum, wind, bearing, uv, clouds, press, vis, dew);
            return std::string(buf);
      - lvgl.label.update:
          id: weather_gps_lbl
          text: !lambda |-
            if (!id(gps_data_alive).state) return std::string("GPS: no NMEA data. Check RX ${gps_rx_pin}/TX ${gps_tx_pin}, then try gps_baud_rate 38400.");
            if (id(gps_satellites).state < 1.0f) return std::string("GPS: data alive, waiting for fix.");
            char buf[120];
            snprintf(buf, sizeof(buf), "GPS fix: %.0f sat  lat %.5f  lon %.5f",
                     id(gps_satellites).state, id(gps_latitude).state, id(gps_longitude).state);
            return std::string(buf);
      - lvgl.label.update:
          id: weather_source_lbl
          text: !lambda |-
            if (id(wx_entity_state).has_state() && !id(wx_entity_state).state.empty()) {
              return std::string("Entity: ${entity_wx_main} = ") + id(wx_entity_state).state;
            }
            return std::string("Entity: ${entity_wx_main} unavailable");
      - lvgl.label.update:
          id: climate_status_lbl
          text: !lambda |-
            char buf[180];
            std::string mode = id(sensi_climate_state).has_state() ? id(sensi_climate_state).state : std::string("-");
            std::string action = id(sensi_climate_hvac_action).has_state() ? id(sensi_climate_hvac_action).state : std::string("-");
            std::string fan = id(sensi_climate_fan_mode).has_state() ? id(sensi_climate_fan_mode).state : std::string("-");
            float t = id(sensi_temperature).state == id(sensi_temperature).state ? id(sensi_temperature).state : 0.0f;
            float h = id(sensi_humidity).state == id(sensi_humidity).state ? id(sensi_humidity).state : 0.0f;
            snprintf(buf, sizeof(buf), "Mode %s  Action %s  Fan %s\nTemp %.1f  Hum %.0f%%",
                     mode.c_str(), action.c_str(), fan.c_str(), t, h);
            return std::string(buf);
      - lvgl.slider.update:
          id: climate_heat_slider
          value: !lambda |-
            if (id(sensi_auto_heat_temp).state == id(sensi_auto_heat_temp).state) return (int) id(sensi_auto_heat_temp).state;
            return 68;
      - lvgl.slider.update:
          id: climate_cool_slider
          value: !lambda |-
            if (id(sensi_auto_cool_temp).state == id(sensi_auto_cool_temp).state) return (int) id(sensi_auto_cool_temp).state;
            return 74;
      - lvgl.slider.update:
          id: climate_hum_offset_slider
          value: !lambda |-
            if (id(sensi_humidity_offset).state == id(sensi_humidity_offset).state) return (int) id(sensi_humidity_offset).state;
            return 0;
      - lvgl.slider.update:
          id: climate_temp_offset_slider
          value: !lambda |-
            if (id(sensi_temperature_offset).state == id(sensi_temperature_offset).state) return (int) id(sensi_temperature_offset).state;
            return 0;
      - lvgl.label.update:
          id: climate_heat_lbl
          text: !lambda |-
            char buf[32];
            int v = id(sensi_auto_heat_temp).state == id(sensi_auto_heat_temp).state ? (int) id(sensi_auto_heat_temp).state : 68;
            snprintf(buf, sizeof(buf), "Heat %d", v);
            return std::string(buf);
      - lvgl.label.update:
          id: climate_cool_lbl
          text: !lambda |-
            char buf[32];
            int v = id(sensi_auto_cool_temp).state == id(sensi_auto_cool_temp).state ? (int) id(sensi_auto_cool_temp).state : 74;
            snprintf(buf, sizeof(buf), "Cool %d", v);
            return std::string(buf);
      - lvgl.label.update:
          id: climate_hum_offset_lbl
          text: !lambda |-
            char buf[32];
            int v = id(sensi_humidity_offset).state == id(sensi_humidity_offset).state ? (int) id(sensi_humidity_offset).state : 0;
            snprintf(buf, sizeof(buf), "HumOff %d", v);
            return std::string(buf);
      - lvgl.label.update:
          id: climate_temp_offset_lbl
          text: !lambda |-
            char buf[32];
            int v = id(sensi_temperature_offset).state == id(sensi_temperature_offset).state ? (int) id(sensi_temperature_offset).state : 0;
            snprintf(buf, sizeof(buf), "TempOff %d", v);
            return std::string(buf);
      - lvgl.label.update:
          id: reader_bbc_lbl
          text: !lambda |-
            std::string t = "latest";
            if (id(feed_bbc_title).has_state() && !id(feed_bbc_title).state.empty()) t = id(feed_bbc_title).state;
            else if (id(feed_bbc_message).has_state() && !id(feed_bbc_message).state.empty()) t = id(feed_bbc_message).state;
            else if (id(feed_bbc_state).has_state() && !id(feed_bbc_state).state.empty()) t = id(feed_bbc_state).state;
            if ((int) t.size() > 28) t = t.substr(0, 28) + "...";
            return std::string("BBC  |  ") + t;
      - lvgl.label.update:
          id: reader_dc_lbl
          text: !lambda |-
            std::string t = "latest";
            if (id(feed_dc_title).has_state() && !id(feed_dc_title).state.empty()) t = id(feed_dc_title).state;
            else if (id(feed_dc_message).has_state() && !id(feed_dc_message).state.empty()) t = id(feed_dc_message).state;
            else if (id(feed_dc_state).has_state() && !id(feed_dc_state).state.empty()) t = id(feed_dc_state).state;
            if ((int) t.size() > 28) t = t.substr(0, 28) + "...";
            return std::string("DC   |  ") + t;
      - lvgl.label.update:
          id: reader_loudoun_lbl
          text: !lambda |-
            std::string t = "latest";
            if (id(feed_loudoun_title).has_state() && !id(feed_loudoun_title).state.empty()) t = id(feed_loudoun_title).state;
            else if (id(feed_loudoun_message).has_state() && !id(feed_loudoun_message).state.empty()) t = id(feed_loudoun_message).state;
            else if (id(feed_loudoun_state).has_state() && !id(feed_loudoun_state).state.empty()) t = id(feed_loudoun_state).state;
            if ((int) t.size() > 24) t = t.substr(0, 24) + "...";
            return std::string("Loudoun  |  ") + t;
      - lvgl.label.update:
          id: reader_word_lbl
          text: !lambda |-
            std::string t = id(word_of_day).has_state() ? id(word_of_day).state : std::string("word unavailable");
            if ((int) t.size() > 30) t = t.substr(0, 30) + "...";
            return std::string("Word  |  ") + t;
      - lvgl.label.update:
          id: reader_quote_lbl
          text: !lambda |-
            std::string t = id(quote_of_hour).has_state() ? id(quote_of_hour).state : std::string("quote unavailable");
            if ((int) t.size() > 29) t = t.substr(0, 29) + "...";
            return std::string("Quote |  ") + t;
      - lvgl.label.update:
          id: settings_saver_lbl
          text: !lambda |-
            char buf[64];
            snprintf(buf, sizeof(buf), "Auto sleep timeout: %ds", id(screensaver_timeout_s));
            return std::string(buf);
      - lvgl.slider.update:
          id: settings_saver_slider
          value: !lambda "return id(screensaver_timeout_s);"
      - lvgl.label.update:
          id: settings_status_lbl
          text: !lambda |-
            char buf[160];
            snprintf(buf, sizeof(buf), "Saver %ds | Wake T/K/B %s/%s/%s | KB %d%%",
                     id(screensaver_timeout_s),
                     id(wake_on_touch) ? "ON" : "OFF",
                     id(wake_on_keyboard) ? "ON" : "OFF",
                     id(wake_on_trackball) ? "ON" : "OFF",
                     id(kb_backlight_percent));
            return std::string(buf);
      - lvgl.label.update:
          id: theme_status_lbl
          text: !lambda |-
            const char *name = "Midnight";
            if (id(theme_index) == 1) name = "Slate";
            if (id(theme_index) == 2) name = "Ember";
            if (id(theme_index) == 3) name = "Moss";
            if (id(theme_index) == 4) name = "Mono";
            const char *kbprof = "Normal";
            if (id(kb_backlight_profile) == 1) kbprof = "Reverse";
            if (id(kb_backlight_profile) == 2) kbprof = "LiveOnly";
            char buf[180];
            snprintf(buf, sizeof(buf), "Theme %s | Disp %d%% | KB %d%% | Profile %s | Debug %s",
                     name,
                     id(backlight_percent),
                     id(kb_backlight_percent),
                     kbprof,
                     id(touch_debug) ? "ON" : "OFF");
            return std::string(buf);
      - lvgl.slider.update:
          id: display_brightness_slider
          value: !lambda "return id(backlight_percent);"
      - lvgl.slider.update:
          id: kb_brightness_slider
          value: !lambda "return id(kb_backlight_percent);"
      - lvgl.label.update:
          id: shortcuts_body_lbl
          text: !lambda |-
            return std::string(
              "ALL SHORTCUTS REQUIRE ALT\n"
              "Alt+H/L/W/C/R/S/T : Home/Lights/Weather/Climate/Reader/Settings/Theme\n"
              "Alt+Q/E : prev/next page     Alt+K : this page\n"
              "Alt+D/F : prev/next light    Alt+G : light toggle\n"
              "Alt+Z/X : dim/bright         Alt+P : preset cycle\n"
              "Alt+B/N/M : keyboard light toggle/down/up\n"
              "Alt+Y : start calibration    Alt+V : reset calibration\n"
              "Cal page: Alt+J Save, Alt+U Retry\n"
              "Alt+O : touch debug toggle\n"
              "Trackball: move focus + click activate"
            );
      - lvgl.label.update:
          id: touch_cal_step_lbl
          text: !lambda |-
            if (id(touch_cal_mode)) {
              if (id(touch_cal_step) == 0) return std::string("1/9 TOP LEFT");
              if (id(touch_cal_step) == 1) return std::string("2/9 TOP CENTER");
              if (id(touch_cal_step) == 2) return std::string("3/9 TOP RIGHT");
              if (id(touch_cal_step) == 3) return std::string("4/9 MID LEFT");
              if (id(touch_cal_step) == 4) return std::string("5/9 CENTER");
              if (id(touch_cal_step) == 5) return std::string("6/9 MID RIGHT");
              if (id(touch_cal_step) == 6) return std::string("7/9 BOTTOM LEFT");
              if (id(touch_cal_step) == 7) return std::string("8/9 BOTTOM CENTER");
              return std::string("9/9 BOTTOM RIGHT");
            }
            if (id(touch_cal_review_pending)) return std::string("Review capture. Save or Retry.");
            if (id(touch_cal_suggest_x_max) > id(touch_cal_suggest_x_min) &&
                id(touch_cal_suggest_y_max) > id(touch_cal_suggest_y_min)) {
              return std::string("Calibration saved. Alt+Y rerun, Alt+V reset.");
            }
            return std::string("Press TouchCal button to start.");
      - lvgl.label.update:
          id: touch_cal_result_lbl
          text: !lambda |-
            char buf[64];
            if (id(touch_cal_review_pending)) {
              snprintf(buf, sizeof(buf),
                       "new x%d-%d y%d-%d",
                       id(touch_cal_candidate_x_min), id(touch_cal_candidate_x_max),
                       id(touch_cal_candidate_y_min), id(touch_cal_candidate_y_max));
              return std::string(buf);
            }
            if (id(touch_cal_suggest_x_max) > id(touch_cal_suggest_x_min) &&
                id(touch_cal_suggest_y_max) > id(touch_cal_suggest_y_min)) {
              snprintf(buf, sizeof(buf),
                       "x%d-%d y%d-%d",
                       id(touch_cal_suggest_x_min), id(touch_cal_suggest_x_max),
                       id(touch_cal_suggest_y_min), id(touch_cal_suggest_y_max));
              return std::string(buf);
            }
            snprintf(buf, sizeof(buf),
                     "raw %d,%d",
                     id(touch_raw_x_last), id(touch_raw_y_last));
            return std::string(buf);
      - lvgl.label.update:
          id: touch_cal_p0_lbl
          text: !lambda "return (id(touch_cal_mode) && id(touch_cal_step) == 0) ? std::string(\"X\") : std::string(\"+\");"
      - lvgl.label.update:
          id: touch_cal_p1_lbl
          text: !lambda "return (id(touch_cal_mode) && id(touch_cal_step) == 1) ? std::string(\"X\") : std::string(\"+\");"
      - lvgl.label.update:
          id: touch_cal_p2_lbl
          text: !lambda "return (id(touch_cal_mode) && id(touch_cal_step) == 2) ? std::string(\"X\") : std::string(\"+\");"
      - lvgl.label.update:
          id: touch_cal_p3_lbl
          text: !lambda "return (id(touch_cal_mode) && id(touch_cal_step) == 3) ? std::string(\"X\") : std::string(\"+\");"
      - lvgl.label.update:
          id: touch_cal_p4_lbl
          text: !lambda "return (id(touch_cal_mode) && id(touch_cal_step) == 4) ? std::string(\"X\") : std::string(\"+\");"
      - lvgl.label.update:
          id: touch_cal_p5_lbl
          text: !lambda "return (id(touch_cal_mode) && id(touch_cal_step) == 5) ? std::string(\"X\") : std::string(\"+\");"
      - lvgl.label.update:
          id: touch_cal_p6_lbl
          text: !lambda "return (id(touch_cal_mode) && id(touch_cal_step) == 6) ? std::string(\"X\") : std::string(\"+\");"
      - lvgl.label.update:
          id: touch_cal_p7_lbl
          text: !lambda "return (id(touch_cal_mode) && id(touch_cal_step) == 7) ? std::string(\"X\") : std::string(\"+\");"
      - lvgl.label.update:
          id: touch_cal_p8_lbl
          text: !lambda "return (id(touch_cal_mode) && id(touch_cal_step) == 8) ? std::string(\"X\") : std::string(\"+\");"

interval:
  - interval: 1s
    then:
      - lambda: |-
          uint32_t now = esphome::millis();
          uint32_t idle_ms = now - id(last_activity_ms);
          if (id(screensaver_enabled) && !id(screensaver_active)) {
            if (idle_ms >= (uint32_t) id(screensaver_timeout_s) * 1000UL) {
              id(sleep_display).execute();
            }
          }

  - interval: 2s
    then:
      - if:
          condition:
            lambda: "return !id(screensaver_active);"
          then:
            - script.execute: lvgl_update_dynamic

  - interval: 15s
    then:
      - if:
          condition:
            lambda: "return id(kb_backlight_percent) > 0;"
          then:
            - script.execute: kb_backlight_apply

lvgl:
  displays:
    - tft
  touchscreens:
    - tdeck_touch
  keypads:
    - id: nav_keypad
      group: nav_group
      prev: tb_left
      next: tb_right
      up: tb_up
      down: tb_down
      enter: tb_click
      long_press_time: 300ms
      long_press_repeat_time: 65535ms

  on_boot:
    then:
      - lambda: |-
          if (id(touch_cal_suggest_x_max) <= id(touch_cal_suggest_x_min) ||
              id(touch_cal_suggest_y_max) <= id(touch_cal_suggest_y_min)) {
            id(touch_cal_suggest_x_min) = atoi("${touch_x_min}");
            id(touch_cal_suggest_x_max) = atoi("${touch_x_max}");
            id(touch_cal_suggest_y_min) = atoi("${touch_y_min}");
            id(touch_cal_suggest_y_max) = atoi("${touch_y_max}");
          }
      - script.execute: touch_cal_apply_stored
      - script.execute: apply_theme
      - lvgl.widget.focus: home_lights_btn
      - script.execute: lvgl_update_dynamic

  style_definitions:
    - id: lv_style_screen
      bg_opa: cover
      bg_color: 0x05070A
      text_color: 0xF2F6FF
    - id: lv_style_card
      bg_opa: cover
      bg_color: 0x0F1624
      border_width: 2
      border_color: 0x283A56
      radius: 10
      pad_all: 6
      text_color: 0xF2F6FF
    - id: lv_style_btn
      bg_opa: cover
      bg_color: 0x17253B
      border_width: 2
      border_color: 0x2F6FD8
      radius: 10
      text_color: 0xF2F6FF
      pad_all: 4
    - id: lv_style_btn_soft
      bg_opa: cover
      bg_color: 0x131A28
      border_width: 2
      border_color: 0x36435D
      radius: 10
      text_color: 0xDCE7FF
      pad_all: 4
    - id: lv_style_btn_warn
      bg_opa: cover
      bg_color: 0x3C1E1E
      border_width: 2
      border_color: 0xB84747
      radius: 10
      text_color: 0xFFE7E7
      pad_all: 4
    - id: lv_style_btn_ok
      bg_opa: cover
      bg_color: 0x173022
      border_width: 2
      border_color: 0x39A466
      radius: 10
      text_color: 0xE8FFF2
      pad_all: 4

  pages:
    - id: home_page
      styles: [lv_style_screen]
      widgets:
        - label:
            id: home_status_lbl
            x: 12
            y: 8
            width: 296
            text: "Status"
        - button:
            id: home_lights_btn
            x: 12
            y: 34
            width: 144
            height: 196
            styles: [lv_style_btn_ok]
            group: nav_group
            on_click:
              - lvgl.page.show: lights_page
            widgets:
              - label:
                  text: "\uF0F3"
                  align: CENTER
        - button:
            id: home_weather_btn
            x: 162
            y: 34
            width: 70
            height: 60
            styles: [lv_style_btn]
            group: nav_group
            on_click:
              - lvgl.page.show: weather_page
            widgets:
              - label:
                  text: "\uF043"
                  align: CENTER
        - button:
            id: home_climate_btn
            x: 238
            y: 34
            width: 70
            height: 60
            styles: [lv_style_btn_ok]
            group: nav_group
            on_click:
              - script.execute: open_climate
            widgets:
              - label:
                  text: "\uF021"
                  align: CENTER
        - button:
            id: home_reader_btn
            x: 162
            y: 100
            width: 70
            height: 60
            styles: [lv_style_btn_soft]
            group: nav_group
            on_click:
              - lvgl.page.show: reader_page
            widgets:
              - label:
                  text: "\uF158"
                  align: CENTER
        - button:
            id: home_settings_btn
            x: 238
            y: 100
            width: 70
            height: 60
            styles: [lv_style_btn_soft]
            group: nav_group
            on_click:
              - lvgl.page.show: settings_page
            widgets:
              - label:
                  text: "\uF013"
                  align: CENTER
        - button:
            id: home_theme_btn
            x: 162
            y: 170
            width: 70
            height: 60
            styles: [lv_style_btn_soft]
            group: nav_group
            on_click:
              - lvgl.page.show: theme_page
            widgets:
              - label:
                  text: "\uF03E"
                  align: CENTER
        - button:
            id: home_sleep_btn
            x: 238
            y: 170
            width: 70
            height: 60
            styles: [lv_style_btn_warn]
            group: nav_group
            on_click:
              - script.execute: sleep_display
            widgets:
              - label:
                  text: "\uF011"
                  align: CENTER

    - id: lights_page
      styles: [lv_style_screen]
      widgets:
        - button:
            id: lights_home_btn
            x: 8
            y: 6
            width: 54
            height: 26
            styles: [lv_style_btn]
            group: nav_group
            on_click:
              - lvgl.page.show: home_page
            widgets:
              - label:
                  text: "\uF015"
                  align: CENTER
        - label:
            x: 72
            y: 10
            text: "Lights"
        - label:
            id: lights_selected_lbl
            x: 130
            y: 8
            width: 182
            text: "Selected"
        - button:
            id: light_foyer_btn
            x: 8
            y: 38
            width: 116
            height: 28
            styles: [lv_style_btn_soft]
            group: nav_group
            on_click:
              - script.execute:
                  id: select_light
                  idx: 0
            widgets:
              - label:
                  id: light_foyer_lbl
                  text: "Foyer"
                  align: CENTER
        - button:
            id: light_vanity_btn
            x: 8
            y: 70
            width: 116
            height: 28
            styles: [lv_style_btn_soft]
            group: nav_group
            on_click:
              - script.execute:
                  id: select_light
                  idx: 1
            widgets:
              - label:
                  id: light_vanity_lbl
                  text: "Vanity"
                  align: CENTER
        - button:
            id: light_bedroom_btn
            x: 8
            y: 102
            width: 116
            height: 28
            styles: [lv_style_btn_soft]
            group: nav_group
            on_click:
              - script.execute:
                  id: select_light
                  idx: 2
            widgets:
              - label:
                  id: light_bedroom_lbl
                  text: "Bedroom"
                  align: CENTER
        - button:
            id: light_hall_btn
            x: 8
            y: 134
            width: 116
            height: 28
            styles: [lv_style_btn_soft]
            group: nav_group
            on_click:
              - script.execute:
                  id: select_light
                  idx: 3
            widgets:
              - label:
                  id: light_hall_lbl
                  text: "Hall"
                  align: CENTER
        - button:
            id: light_office_btn
            x: 8
            y: 166
            width: 116
            height: 28
            styles: [lv_style_btn_soft]
            group: nav_group
            on_click:
              - script.execute:
                  id: select_light
                  idx: 4
            widgets:
              - label:
                  id: light_office_lbl
                  text: "Office"
                  align: CENTER
        - button:
            id: light_upstairs_btn
            x: 8
            y: 198
            width: 116
            height: 28
            styles: [lv_style_btn_soft]
            group: nav_group
            on_click:
              - script.execute:
                  id: select_light
                  idx: 5
            widgets:
              - label:
                  id: light_upstairs_lbl
                  text: "Upstairs"
                  align: CENTER
        - button:
            x: 130
            y: 42
            width: 182
            height: 30
            styles: [lv_style_btn_ok]
            group: nav_group
            on_click:
              - script.execute: selected_light_toggle
            widgets:
              - label:
                  text: "Toggle"
                  align: CENTER
        - button:
            x: 130
            y: 76
            width: 88
            height: 28
            styles: [lv_style_btn_soft]
            group: nav_group
            on_click:
              - script.execute: selected_light_dimmer
            widgets:
              - label:
                  text: "Dim"
                  align: CENTER
        - button:
            x: 224
            y: 76
            width: 88
            height: 28
            styles: [lv_style_btn]
            group: nav_group
            on_click:
              - script.execute: selected_light_brighter
            widgets:
              - label:
                  text: "Bright"
                  align: CENTER
        - label:
            id: lights_brightness_lbl
            x: 130
            y: 106
            width: 182
            text: "Brightness 60%"
        - slider:
            id: light_brightness_slider
            x: 130
            y: 124
            width: 182
            min_value: 1
            max_value: 100
            value: 60
            group: nav_group
            on_release:
              - script.execute:
                  id: selected_light_set_brightness_pct
                  pct: !lambda "return (int)x;"
        - label:
            id: lights_kelvin_lbl
            x: 130
            y: 144
            width: 182
            text: "Color Temp 4000K"
        - slider:
            id: light_temp_slider
            x: 130
            y: 162
            width: 182
            min_value: 2200
            max_value: 6500
            value: 4000
            group: nav_group
            on_release:
              - script.execute:
                  id: selected_light_set_kelvin
                  kelvin: !lambda "return (int)x;"
        - button:
            x: 130
            y: 182
            width: 88
            height: 24
            styles: [lv_style_btn_soft]
            group: nav_group
            on_click:
              - script.execute: selected_light_warm
            widgets:
              - label:
                  text: "Warm"
                  align: CENTER
        - button:
            x: 224
            y: 182
            width: 88
            height: 24
            styles: [lv_style_btn]
            group: nav_group
            on_click:
              - script.execute: selected_light_cool
            widgets:
              - label:
                  text: "Cool"
                  align: CENTER
        - button:
            x: 130
            y: 210
            width: 42
            height: 20
            styles: [lv_style_btn_warn]
            group: nav_group
            on_click:
              - script.execute:
                  id: selected_light_color
                  cname: "red"
            widgets:
              - label:
                  text: "R"
                  align: CENTER
        - button:
            x: 176
            y: 210
            width: 42
            height: 20
            styles: [lv_style_btn]
            group: nav_group
            on_click:
              - script.execute:
                  id: selected_light_color
                  cname: "blue"
            widgets:
              - label:
                  text: "B"
                  align: CENTER
        - button:
            x: 222
            y: 210
            width: 42
            height: 20
            styles: [lv_style_btn_ok]
            group: nav_group
            on_click:
              - script.execute:
                  id: selected_light_color
                  cname: "white"
            widgets:
              - label:
                  text: "W"
                  align: CENTER
        - button:
            x: 268
            y: 210
            width: 44
            height: 20
            styles: [lv_style_btn_soft]
            group: nav_group
            on_click:
              - script.execute: selected_light_preset_cycle
            widgets:
              - label:
                  text: "P"
                  align: CENTER
        - label:
            id: lights_preset_lbl
            x: 130
            y: 228
            width: 182
            text: "Preset"

    - id: weather_page
      styles: [lv_style_screen]
      widgets:
        - button:
            x: 8
            y: 6
            width: 54
            height: 26
            styles: [lv_style_btn]
            group: nav_group
            on_click:
              - lvgl.page.show: home_page
            widgets:
              - label:
                  text: "\uF015"
                  align: CENTER
        - button:
            x: 256
            y: 6
            width: 52
            height: 26
            styles: [lv_style_btn_soft]
            group: nav_group
            on_click:
              - script.execute: open_climate
            widgets:
              - label:
                  text: "TEMP"
                  align: CENTER
        - label:
            x: 72
            y: 10
            text: "Weather + GPS"
        - label:
            id: weather_temp_lbl
            x: 12
            y: 40
            text: "--"
        - label:
            id: weather_cond_lbl
            x: 12
            y: 74
            width: 296
            text: "-"
        - label:
            id: weather_feels_lbl
            x: 12
            y: 98
            width: 296
            text: "Feels --"
        - label:
            id: weather_metrics_lbl
            x: 12
            y: 126
            width: 296
            text: "metrics"
        - label:
            id: weather_gps_lbl
            x: 12
            y: 206
            width: 296
            text: "GPS"
        - label:
            id: weather_source_lbl
            x: 12
            y: 186
            width: 296
            text: "Entity state"

    - id: climate_page
      styles: [lv_style_screen]
      widgets:
        - button:
            x: 8
            y: 6
            width: 54
            height: 26
            styles: [lv_style_btn]
            group: nav_group
            on_click:
              - lvgl.page.show: home_page
            widgets:
              - label:
                  text: "\uF015"
                  align: CENTER
        - label:
            x: 72
            y: 10
            text: "Climate"
        - button:
            x: 256
            y: 6
            width: 52
            height: 26
            styles: [lv_style_btn_soft]
            group: nav_group
            on_click:
              - lvgl.page.show: weather_page
            widgets:
              - label:
                  text: "\uF043"
                  align: CENTER
        - button:
            x: 12
            y: 40
            width: 68
            height: 24
            styles: [lv_style_btn_soft]
            group: nav_group
            on_click:
              - script.execute: sensi_hvac_mode_off
            widgets:
              - label:
                  text: "Off"
                  align: CENTER
        - button:
            x: 84
            y: 40
            width: 68
            height: 24
            styles: [lv_style_btn_soft]
            group: nav_group
            on_click:
              - script.execute: sensi_hvac_mode_heat
            widgets:
              - label:
                  text: "Heat"
                  align: CENTER
        - button:
            x: 156
            y: 40
            width: 68
            height: 24
            styles: [lv_style_btn_soft]
            group: nav_group
            on_click:
              - script.execute: sensi_hvac_mode_cool
            widgets:
              - label:
                  text: "Cool"
                  align: CENTER
        - button:
            x: 228
            y: 40
            width: 68
            height: 24
            styles: [lv_style_btn_soft]
            group: nav_group
            on_click:
              - script.execute: sensi_hvac_mode_auto
            widgets:
              - label:
                  text: "Auto"
                  align: CENTER
        - label:
            id: climate_status_lbl
            x: 12
            y: 68
            width: 296
            height: 32
            text: "mode/action/status"
        - label:
            id: climate_heat_lbl
            x: 12
            y: 102
            width: 146
            text: "Heat Set 68"
        - slider:
            id: climate_heat_slider
            x: 12
            y: 118
            width: 146
            min_value: 50
            max_value: 90
            value: 68
            group: nav_group
            on_release:
              - script.execute:
                  id: sensi_set_heat_target
                  val: !lambda "return (int)x;"
        - label:
            id: climate_cool_lbl
            x: 166
            y: 102
            width: 146
            text: "Cool Set 74"
        - slider:
            id: climate_cool_slider
            x: 166
            y: 118
            width: 146
            min_value: 50
            max_value: 95
            value: 74
            group: nav_group
            on_release:
              - script.execute:
                  id: sensi_set_cool_target
                  val: !lambda "return (int)x;"
        - label:
            id: climate_hum_offset_lbl
            x: 12
            y: 142
            width: 146
            text: "Hum Off 0"
        - slider:
            id: climate_hum_offset_slider
            x: 12
            y: 158
            width: 146
            min_value: -20
            max_value: 20
            value: 0
            group: nav_group
            on_release:
              - script.execute:
                  id: sensi_set_humidity_offset
                  val: !lambda "return (int)x;"
        - label:
            id: climate_temp_offset_lbl
            x: 166
            y: 142
            width: 146
            text: "Temp Off 0"
        - slider:
            id: climate_temp_offset_slider
            x: 166
            y: 158
            width: 146
            min_value: -10
            max_value: 10
            value: 0
            group: nav_group
            on_release:
              - script.execute:
                  id: sensi_set_temperature_offset
                  val: !lambda "return (int)x;"
        - button:
            x: 12
            y: 184
            width: 96
            height: 24
            styles: [lv_style_btn_soft]
            group: nav_group
            on_click:
              - script.execute: sensi_toggle_aux_heat
            widgets:
              - label:
                  text: "Aux"
                  align: CENTER
        - button:
            x: 112
            y: 184
            width: 96
            height: 24
            styles: [lv_style_btn_soft]
            group: nav_group
            on_click:
              - script.execute: sensi_toggle_display_humidity
            widgets:
              - label:
                  text: "Hum"
                  align: CENTER
        - button:
            x: 212
            y: 184
            width: 96
            height: 24
            styles: [lv_style_btn_soft]
            group: nav_group
            on_click:
              - script.execute: sensi_toggle_display_time
            widgets:
              - label:
                  text: "Time"
                  align: CENTER
        - button:
            x: 12
            y: 212
            width: 96
            height: 24
            styles: [lv_style_btn_soft]
            group: nav_group
            on_click:
              - script.execute: sensi_toggle_fan_support
            widgets:
              - label:
                  text: "Fan"
                  align: CENTER
        - button:
            x: 112
            y: 212
            width: 96
            height: 24
            styles: [lv_style_btn_soft]
            group: nav_group
            on_click:
              - script.execute: sensi_toggle_humidification
            widgets:
              - label:
                  text: "Humid"
                  align: CENTER
        - button:
            x: 212
            y: 212
            width: 96
            height: 24
            styles: [lv_style_btn_soft]
            group: nav_group
            on_click:
              - script.execute: sensi_toggle_keypad_lockout
            widgets:
              - label:
                  text: "Lock"
                  align: CENTER

    - id: reader_page
      styles: [lv_style_screen]
      widgets:
        - button:
            x: 8
            y: 6
            width: 54
            height: 26
            styles: [lv_style_btn]
            group: nav_group
            on_click:
              - lvgl.page.show: home_page
            widgets:
              - label:
                  text: "\uF015"
                  align: CENTER
        - label:
            x: 72
            y: 10
            text: "Reader"
        - button:
            id: reader_bbc_btn
            x: 12
            y: 38
            width: 296
            height: 30
            styles: [lv_style_btn_soft]
            group: nav_group
            on_click:
              - script.execute: open_detail_bbc
            widgets:
              - label:
                  id: reader_bbc_lbl
                  text: "BBC"
                  align: CENTER
        - button:
            id: reader_dc_btn
            x: 12
            y: 72
            width: 296
            height: 30
            styles: [lv_style_btn_soft]
            group: nav_group
            on_click:
              - script.execute: open_detail_dc
            widgets:
              - label:
                  id: reader_dc_lbl
                  text: "DC"
                  align: CENTER
        - button:
            id: reader_loudoun_btn
            x: 12
            y: 106
            width: 296
            height: 30
            styles: [lv_style_btn_soft]
            group: nav_group
            on_click:
              - script.execute: open_detail_loudoun
            widgets:
              - label:
                  id: reader_loudoun_lbl
                  text: "Loudoun"
                  align: CENTER
        - button:
            id: reader_word_btn
            x: 12
            y: 140
            width: 296
            height: 30
            styles: [lv_style_btn]
            group: nav_group
            on_click:
              - script.execute: open_detail_word
            widgets:
              - label:
                  id: reader_word_lbl
                  text: "Word"
                  align: CENTER
        - button:
            id: reader_quote_btn
            x: 12
            y: 174
            width: 296
            height: 30
            styles: [lv_style_btn]
            group: nav_group
            on_click:
              - script.execute: open_detail_quote
            widgets:
              - label:
                  id: reader_quote_lbl
                  text: "Quote"
                  align: CENTER

    - id: settings_page
      styles: [lv_style_screen]
      widgets:
        - button:
            x: 8
            y: 6
            width: 54
            height: 26
            styles: [lv_style_btn]
            group: nav_group
            on_click:
              - lvgl.page.show: home_page
            widgets:
              - label:
                  text: "\uF015"
                  align: CENTER
        - label:
            x: 72
            y: 10
            text: "Settings"
        - button:
            x: 12
            y: 38
            width: 96
            height: 52
            styles: [lv_style_btn]
            group: nav_group
            on_click:
              - script.execute: saver_timeout_down
            widgets:
              - label:
                  text: "Saver-"
                  align: CENTER
        - button:
            x: 112
            y: 38
            width: 96
            height: 52
            styles: [lv_style_btn]
            group: nav_group
            on_click:
              - script.execute: saver_timeout_up
            widgets:
              - label:
                  text: "Saver+"
                  align: CENTER
        - button:
            x: 212
            y: 38
            width: 96
            height: 52
            styles: [lv_style_btn_soft]
            group: nav_group
            on_click:
              - script.execute: kb_backlight_toggle
            widgets:
              - label:
                  text: "KB Light"
                  align: CENTER
        - button:
            x: 12
            y: 96
            width: 96
            height: 52
            styles: [lv_style_btn]
            group: nav_group
            on_click:
              - script.execute: toggle_wake_touch
            widgets:
              - label:
                  text: "WakeTouch"
                  align: CENTER
        - button:
            x: 112
            y: 96
            width: 96
            height: 52
            styles: [lv_style_btn]
            group: nav_group
            on_click:
              - script.execute: toggle_wake_keyboard
            widgets:
              - label:
                  text: "WakeKeys"
                  align: CENTER
        - button:
            x: 212
            y: 96
            width: 96
            height: 52
            styles: [lv_style_btn]
            group: nav_group
            on_click:
              - script.execute: toggle_wake_trackball
            widgets:
              - label:
                  text: "WakeBall"
                  align: CENTER
        - label:
            id: settings_saver_lbl
            x: 12
            y: 154
            width: 296
            text: "Auto sleep timeout"
        - slider:
            id: settings_saver_slider
            x: 12
            y: 170
            width: 296
            min_value: 10
            max_value: 300
            value: 45
            group: nav_group
            on_release:
              - script.execute:
                  id: set_saver_timeout
                  seconds: !lambda "return (int)x;"
        - button:
            x: 12
            y: 194
            width: 96
            height: 32
            styles: [lv_style_btn_soft]
            group: nav_group
            on_click:
              - script.execute: start_touch_calibration
            widgets:
              - label:
                  text: "Cal"
                  align: CENTER
        - button:
            x: 112
            y: 194
            width: 96
            height: 32
            styles: [lv_style_btn_soft]
            group: nav_group
            on_click:
              - script.execute: open_shortcuts
            widgets:
              - label:
                  text: "Keys"
                  align: CENTER
        - button:
            x: 212
            y: 194
            width: 96
            height: 32
            styles: [lv_style_btn_soft]
            group: nav_group
            on_click:
              - script.execute: sleep_display
            widgets:
              - label:
                  text: "\uF011"
                  align: CENTER
        - label:
            id: settings_status_lbl
            x: 12
            y: 224
            width: 296
            text: "settings"

    - id: theme_page
      styles: [lv_style_screen]
      widgets:
        - button:
            x: 8
            y: 6
            width: 54
            height: 26
            styles: [lv_style_btn]
            group: nav_group
            on_click:
              - lvgl.page.show: home_page
            widgets:
              - label:
                  text: "\uF015"
                  align: CENTER
        - label:
            x: 72
            y: 10
            text: "Theme"
        - button:
            x: 12
            y: 38
            width: 56
            height: 28
            styles: [lv_style_btn_soft]
            group: nav_group
            on_click:
              - lambda: |-
                  id(theme_index) = 0;
              - script.execute: apply_theme
            widgets:
              - label:
                  text: "Night"
                  align: CENTER
        - button:
            x: 72
            y: 38
            width: 56
            height: 28
            styles: [lv_style_btn_soft]
            group: nav_group
            on_click:
              - lambda: |-
                  id(theme_index) = 1;
              - script.execute: apply_theme
            widgets:
              - label:
                  text: "Slate"
                  align: CENTER
        - button:
            x: 132
            y: 38
            width: 56
            height: 28
            styles: [lv_style_btn_soft]
            group: nav_group
            on_click:
              - lambda: |-
                  id(theme_index) = 2;
              - script.execute: apply_theme
            widgets:
              - label:
                  text: "Ember"
                  align: CENTER
        - button:
            x: 192
            y: 38
            width: 56
            height: 28
            styles: [lv_style_btn_soft]
            group: nav_group
            on_click:
              - lambda: |-
                  id(theme_index) = 3;
              - script.execute: apply_theme
            widgets:
              - label:
                  text: "Moss"
                  align: CENTER
        - button:
            x: 252
            y: 38
            width: 56
            height: 28
            styles: [lv_style_btn_soft]
            group: nav_group
            on_click:
              - lambda: |-
                  id(theme_index) = 4;
              - script.execute: apply_theme
            widgets:
              - label:
                  text: "Mono"
                  align: CENTER
        - label:
            x: 12
            y: 72
            width: 296
            text: "Display Brightness"
        - slider:
            id: display_brightness_slider
            x: 12
            y: 90
            width: 296
            min_value: 10
            max_value: 100
            value: 80
            group: nav_group
            on_release:
              - script.execute:
                  id: set_display_backlight
                  pct: !lambda "return (int)x;"
        - label:
            x: 12
            y: 112
            width: 296
            text: "Keyboard Backlight"
        - slider:
            id: kb_brightness_slider
            x: 12
            y: 130
            width: 296
            min_value: 0
            max_value: 100
            value: 70
            group: nav_group
            on_release:
              - script.execute:
                  id: set_kb_backlight
                  pct: !lambda "return (int)x;"
        - button:
            x: 12
            y: 160
            width: 146
            height: 32
            styles: [lv_style_btn]
            group: nav_group
            on_click:
              - script.execute: toggle_touch_debug
            widgets:
              - label:
                  text: "Touch Debug"
                  align: CENTER
        - button:
            x: 162
            y: 160
            width: 146
            height: 32
            styles: [lv_style_btn_soft]
            group: nav_group
            on_click:
              - script.execute: theme_prev
            widgets:
              - label:
                  text: "Prev Theme"
                  align: CENTER
        - button:
            x: 12
            y: 196
            width: 146
            height: 32
            styles: [lv_style_btn_soft]
            group: nav_group
            on_click:
              - script.execute: kb_backlight_profile_next
            widgets:
              - label:
                  text: "KB Profile"
                  align: CENTER
        - button:
            x: 162
            y: 196
            width: 146
            height: 32
            styles: [lv_style_btn_soft]
            group: nav_group
            on_click:
              - script.execute: theme_next
            widgets:
              - label:
                  text: "Next Theme"
                  align: CENTER
        - label:
            id: theme_status_lbl
            x: 12
            y: 216
            width: 296
            text: "theme"

    - id: touch_cal_page
      styles: [lv_style_screen]
      widgets:
        - label:
            x: 12
            y: 6
            text: "Touch Calibration 9-Point"
        - button:
            x: 214
            y: 4
            width: 48
            height: 22
            styles: [lv_style_btn_ok]
            group: nav_group
            on_click:
              - script.execute: touch_cal_save
            widgets:
              - label:
                  text: "Save"
                  align: CENTER
        - button:
            x: 266
            y: 4
            width: 48
            height: 22
            styles: [lv_style_btn_warn]
            group: nav_group
            on_click:
              - script.execute: touch_cal_retry
            widgets:
              - label:
                  text: "Retry"
                  align: CENTER
        - label:
            id: touch_cal_result_lbl
            x: 12
            y: 28
            width: 302
            text: "raw"
        - label:
            id: touch_cal_p0_lbl
            x: 16
            y: 44
            text: "+"
        - label:
            id: touch_cal_p1_lbl
            x: 158
            y: 44
            text: "+"
        - label:
            id: touch_cal_p2_lbl
            x: 300
            y: 44
            text: "+"
        - label:
            id: touch_cal_p3_lbl
            x: 16
            y: 122
            text: "+"
        - label:
            id: touch_cal_p4_lbl
            x: 158
            y: 122
            text: "+"
        - label:
            id: touch_cal_p5_lbl
            x: 300
            y: 122
            text: "+"
        - label:
            id: touch_cal_p6_lbl
            x: 16
            y: 200
            text: "+"
        - label:
            id: touch_cal_p7_lbl
            x: 158
            y: 200
            text: "+"
        - label:
            id: touch_cal_p8_lbl
            x: 300
            y: 200
            text: "+"
        - label:
            id: touch_cal_step_lbl
            x: 12
            y: 220
            width: 308
            text: "1/9 TOP LEFT"

    - id: shortcuts_page
      styles: [lv_style_screen]
      widgets:
        - button:
            x: 8
            y: 6
            width: 60
            height: 30
            styles: [lv_style_btn_soft]
            group: nav_group
            on_click:
              - lvgl.page.show: home_page
            widgets:
              - label:
                  text: "\uF015"
                  align: CENTER
        - label:
            x: 80
            y: 10
            text: "Keyboard Shortcuts"
        - label:
            id: shortcuts_body_lbl
            x: 12
            y: 44
            width: 308
            text: "shortcuts"

    - id: detail_page
      styles: [lv_style_screen]
      widgets:
        - button:
            x: 8
            y: 6
            width: 60
            height: 30
            styles: [lv_style_btn]
            group: nav_group
            on_click:
              - lvgl.page.show: reader_page
            widgets:
              - label:
                  text: "Back"
                  align: CENTER
        - label:
            id: detail_title_lbl
            x: 70
            y: 10
            text: "Detail"
        - label:
            id: detail_body_lbl
            x: 12
            y: 42
            width: 296
            height: 184
            text: ""

